{% extends "base.html" %}

{% block title %}Painel – Agro Digital{% endblock %}

{% block content %}

<header class="sub-header center">
    <h2>Cálculo para área de plantio</h2>
</header>

<!-- lista de cálculos já realizados -->
<div class="card" style="margin-top: 1rem;">
  <header class="sub-header">
    <h3>Áreas calculadas</h3>
  </header>

    <div class="table-wrapper" style="overflow:auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Cultura</th>
            <th>Produto</th>
            <th>Área total (m²)</th>
            <th>Área de plantio (m²)</th>
            <th>Qtd. ruas</th>
            <th>Qtd. produto</th>
            <th>Criado</th>
          </tr>
        </thead>
        <tbody>
          {% for calc in calcs %}
            {% set d = (calc.created_at|string)[:10] %}
            {% set t = (calc.created_at|string)[11:16] %}
            <tr>
              <td>{{ calc.culture_name|capitalize }}</td>
              <td>{{ calc.product_name }}</td>
              <td>{{ '%.2f'|format((calc.total_area_m2 or 0)|float) }}</td>
              <td>{{ '%.2f'|format((calc.planting_area_m2 or 0)|float) }}</td>
              <td>{{ calc.number_of_streets }}</td>
              <td>{{ '%.4f'|format((calc.product_qty or 0)|float) }}</td>
              <td>{{ d[8:10] }}/{{ d[5:7] }}/{{ d[0:4] }} {{ t }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
</div>

<div class="card d-none" id="new-culture-container">
    <span class="close-container" id="close-container">x</span>
    <h3>Cadastro de nova cultura</h3>
    <form id="new-culture-form">
        <div class="form-container">
            <label for="culture-name">
                <span>Nome</span>
                <input type="text" name="culture_name" id="culture-name" required>
            </label>
        </div>

        <div class="form-container">
            <label for="culture-format">
                <span>Formato</span>
                <select name="culture_format" id="culture-format" required>
                    <option value="">-- Selecione --</option>
                    {% for format in formats %}
                        <option value="{{format.id}}">{{format.code}}</option>
                    {% endfor %}
                </select>
            </label>
        </div>

        <div class="form-container">
            <label for="culture-product">
                <span>Produto</span>
                <select name="culture_product" id="culture-product" required>
                    <option value="">-- Selecione --</option>
                    {% for product in products %}
                        <option value="{{product.id}}">{{product.name}}</option>
                    {% endfor %}
                </select>
            </label>
        </div>

        <div class="form-container">
            <label for="culture-street-size">
                <span>Largura da rua em m2</span>
                <input type="number" name="street_size_m" id="culture-street-size" required>
            </label>
        </div>

        <div class="form-container">
            <button>Cadastrar cultura</button>
        </div>
    </form>
</div>

<div class="card">
    <form id="calc-area-form" action="{{ endpoint }}">
        <div class="form-container">
            <label for="culture">
                <span>Selecione uma cultura</span>
                <select name="culture" id="culture" required>
                    <option value="">-- Selecione --</option>
                    {% for culture in cultures %}
                        <option value="{{ culture.id }}">{{ culture.name | capitalize }}</option>
                    {% endfor %}
                </select>
            </label>
            <button id="register-culture">Cadastrar nova cultura</button>
        </div>

        <div class="form-container">
            <label for="area">
                <span>Digite a área total de plantio em metros quadrados</span>
                <input type="number" name="area" id="area" required>
            </label>
        </div>

        <button>Calcular</button>
    </form>
</div>


<script>
let newCultureVisibility = false
const newCultureButton = document.getElementById('register-culture')
const newCultureContainer = document.getElementById('new-culture-container')
const closeContainer = document.getElementById('close-container')
const newCultureForm = document.getElementById('new-culture-form')

newCultureForm.addEventListener('submit', function(event) {
    event.preventDefault()
    event.stopImmediatePropagation()

    let data = Object.fromEntries(new FormData(this))

    if (!data.culture_name || !data.culture_format || !data.culture_product || !data.street_size_m) {
        alert('Dados incompletos')
        return
    }

    fetch('/api/culture', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if ( !response.ok ) { throw new Error ("Erro na requisição")}
        return response.json()
    })
    .then(data => {
        alert(`Cultura ${data.name} cadastrada com sucesso!`)
        window.location.reload()
    })
    .catch(error => {
        console.error(error)
        alert('Erro ao registrar cultura.')
    })
})

const toggleNewCultureForm = () => {
    if ( newCultureVisibility ) {
        newCultureContainer.classList.remove('d-none')
        return null
    }

    newCultureContainer.classList.add('d-none')
}

newCultureButton.addEventListener('click', event => {
    event.preventDefault()
    newCultureVisibility = true
    toggleNewCultureForm()
})

closeContainer.addEventListener('click', event => {
    newCultureVisibility = false
    toggleNewCultureForm()
})

const form = document.getElementById('calc-area-form')
form.addEventListener('submit', function(event) {
    event.preventDefault()
    let data = Object.fromEntries(new FormData(this))

    data = {
        'culture': parseInt(data.culture),
        'area': parseFloat(data.area)
    }

    if(!data.culture) {
        alert('Selecione uma cultura')
        return
    }

    if (isNaN(data.area) || data.area <= 0) {
        alert("Informe uma área válida")
        return
    }

    fetch('/api/calc-area', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) throw new Error('Erro na requisição')
        return response.json()
    })
    .then(data => {
        const tableBody = document.querySelector('.table tbody')
        if (!tableBody) return console.warn('Tabela não encontrada.')

        const created = data.created_at ? new Date(data.created_at) : new Date()
        const d = created.toISOString().slice(0, 10)
        const t = created.toISOString().slice(11, 16)
        const dataFormatada = `${d.slice(8,10)}/${d.slice(5,7)}/${d.slice(0,4)} ${t}`

        // Cria nova linha
        const row = document.createElement('tr')
        row.innerHTML = `
            <td>${data.culture_name || '-'}</td>
            <td>${data.product_name || '-'}</td>
            <td>${Number(data.total_area_m2).toFixed(2)}</td>
            <td>${Number(data.planting_area_m2).toFixed(2)}</td>
            <td>${data.number_of_streets || 0}</td>
            <td>${Number(data.product_qty).toFixed(4)}</td>
            <td>${dataFormatada}</td>
        `
        tableBody.prepend(row)
        alert('Cálculo registrado com sucesso!')
        form.reset()
    })
    .catch(error => {
        console.error(error)
        alert('Erro ao registrar cálculo.')
    })
})
</script>


{% endblock %}